{
  "version": 3,
  "sources": ["../../../src/lib/config/TLSessionStateSnapshot.ts"],
  "sourcesContent": ["import { Signal, computed, transact } from '@tldraw/state'\nimport {\n\tRecordsDiff,\n\tUnknownRecord,\n\tdefineMigrations,\n\tmigrate,\n\tsquashRecordDiffs,\n} from '@tldraw/store'\nimport {\n\tCameraRecordType,\n\tInstancePageStateRecordType,\n\tTLINSTANCE_ID,\n\tTLPageId,\n\tTLRecord,\n\tTLShapeId,\n\tTLStore,\n\tpageIdValidator,\n\tshapeIdValidator,\n} from '@tldraw/tlschema'\nimport { objectMapFromEntries } from '@tldraw/utils'\nimport { T } from '@tldraw/validate'\nimport { uniqueId } from '../utils/uniqueId'\n\nconst tabIdKey = 'TLDRAW_TAB_ID_v2' as const\n\nconst window = globalThis.window as\n\t| {\n\t\t\tnavigator: Window['navigator']\n\t\t\tlocalStorage: Window['localStorage']\n\t\t\tsessionStorage: Window['sessionStorage']\n\t\t\taddEventListener: Window['addEventListener']\n\t\t\tTLDRAW_TAB_ID_v2?: string\n\t  }\n\t| undefined\n\n// https://stackoverflow.com/a/9039885\nfunction iOS() {\n\tif (!window) return false\n\treturn (\n\t\t['iPad Simulator', 'iPhone Simulator', 'iPod Simulator', 'iPad', 'iPhone', 'iPod'].includes(\n\t\t\twindow.navigator.platform\n\t\t) ||\n\t\t// iPad on iOS 13 detection\n\t\t(window.navigator.userAgent.includes('Mac') && 'ontouchend' in document)\n\t)\n}\n\n/**\n * A string that is unique per browser tab\n * @public\n */\nexport const TAB_ID: string =\n\twindow?.[tabIdKey] ?? window?.sessionStorage[tabIdKey] ?? `TLDRAW_INSTANCE_STATE_V1_` + uniqueId()\nif (window) {\n\twindow[tabIdKey] = TAB_ID\n\tif (iOS()) {\n\t\t// iOS does not trigger beforeunload\n\t\t// so we need to keep the sessionStorage value around\n\t\t// and hope the user doesn't figure out a way to duplicate their tab\n\t\t// in which case they'll have two tabs with the same UI state.\n\t\t// It's not a big deal, but it's not ideal.\n\t\t// And anyway I can't see a way to duplicate a tab in iOS Safari.\n\t\twindow.sessionStorage[tabIdKey] = TAB_ID\n\t} else {\n\t\tdelete window.sessionStorage[tabIdKey]\n\t}\n}\n\nwindow?.addEventListener('beforeunload', () => {\n\twindow.sessionStorage[tabIdKey] = TAB_ID\n})\n\nconst Versions = {\n\tInitial: 0,\n} as const\n\nexport const CURRENT_SESSION_STATE_SNAPSHOT_VERSION = Versions.Initial\n\n/**\n * The state of the editor instance, not including any document state.\n *\n * @public\n */\nexport interface TLSessionStateSnapshot {\n\tversion: number\n\tcurrentPageId: TLPageId\n\tisFocusMode: boolean\n\texportBackground: boolean\n\tisDebugMode: boolean\n\tisToolLocked: boolean\n\tisGridMode: boolean\n\tpageStates: Array<{\n\t\tpageId: TLPageId\n\t\tcamera: { x: number; y: number; z: number }\n\t\tselectedShapeIds: TLShapeId[]\n\t\tfocusedGroupId: TLShapeId | null\n\t}>\n}\n\nconst sessionStateSnapshotValidator: T.Validator<TLSessionStateSnapshot> = T.object({\n\tversion: T.number,\n\tcurrentPageId: pageIdValidator,\n\tisFocusMode: T.boolean,\n\texportBackground: T.boolean,\n\tisDebugMode: T.boolean,\n\tisToolLocked: T.boolean,\n\tisGridMode: T.boolean,\n\tpageStates: T.arrayOf(\n\t\tT.object({\n\t\t\tpageId: pageIdValidator,\n\t\t\tcamera: T.object({\n\t\t\t\tx: T.number,\n\t\t\t\ty: T.number,\n\t\t\t\tz: T.number,\n\t\t\t}),\n\t\t\tselectedShapeIds: T.arrayOf(shapeIdValidator),\n\t\t\tfocusedGroupId: shapeIdValidator.nullable(),\n\t\t})\n\t),\n})\n\nconst sessionStateSnapshotMigrations = defineMigrations({\n\tcurrentVersion: CURRENT_SESSION_STATE_SNAPSHOT_VERSION,\n})\n\nfunction migrateAndValidateSessionStateSnapshot(state: unknown): TLSessionStateSnapshot | null {\n\tif (!state || typeof state !== 'object') {\n\t\tconsole.warn('Invalid instance state')\n\t\treturn null\n\t}\n\tif (!('version' in state) || typeof state.version !== 'number') {\n\t\tconsole.warn('No version in instance state')\n\t\treturn null\n\t}\n\tconst result = migrate<TLSessionStateSnapshot>({\n\t\tvalue: state,\n\t\tfromVersion: state.version,\n\t\ttoVersion: CURRENT_SESSION_STATE_SNAPSHOT_VERSION,\n\t\tmigrations: sessionStateSnapshotMigrations,\n\t})\n\tif (result.type === 'error') {\n\t\tconsole.warn(result.reason)\n\t\treturn null\n\t}\n\n\tconst value = { ...result.value, version: CURRENT_SESSION_STATE_SNAPSHOT_VERSION }\n\n\ttry {\n\t\tsessionStateSnapshotValidator.validate(value)\n\t} catch (e) {\n\t\tconsole.warn(e)\n\t\treturn null\n\t}\n\n\treturn value\n}\n\n/**\n * Creates a signal of the instance state for a given store.\n * @public\n * @param store - The store to create the instance state snapshot signal for\n * @returns\n */\nexport function createSessionStateSnapshotSignal(\n\tstore: TLStore\n): Signal<TLSessionStateSnapshot | null> {\n\tconst $allPageIds = store.query.ids('page')\n\n\treturn computed<TLSessionStateSnapshot | null>('sessionStateSnapshot', () => {\n\t\tconst instanceState = store.get(TLINSTANCE_ID)\n\t\tif (!instanceState) return null\n\n\t\tconst allPageIds = [...$allPageIds.get()]\n\t\treturn {\n\t\t\tversion: CURRENT_SESSION_STATE_SNAPSHOT_VERSION,\n\t\t\tcurrentPageId: instanceState.currentPageId,\n\t\t\texportBackground: instanceState.exportBackground,\n\t\t\tisFocusMode: instanceState.isFocusMode,\n\t\t\tisDebugMode: instanceState.isDebugMode,\n\t\t\tisToolLocked: instanceState.isToolLocked,\n\t\t\tisGridMode: instanceState.isGridMode,\n\t\t\tpageStates: allPageIds.map((id) => {\n\t\t\t\tconst ps = store.get(InstancePageStateRecordType.createId(id))\n\t\t\t\tconst camera = store.get(CameraRecordType.createId(id))\n\t\t\t\treturn {\n\t\t\t\t\tpageId: id,\n\t\t\t\t\tcamera: {\n\t\t\t\t\t\tx: camera?.x ?? 0,\n\t\t\t\t\t\ty: camera?.y ?? 0,\n\t\t\t\t\t\tz: camera?.z ?? 1,\n\t\t\t\t\t},\n\t\t\t\t\tselectedShapeIds: ps?.selectedShapeIds ?? [],\n\t\t\t\t\tfocusedGroupId: ps?.focusedGroupId ?? null,\n\t\t\t\t} satisfies TLSessionStateSnapshot['pageStates'][0]\n\t\t\t}),\n\t\t} satisfies TLSessionStateSnapshot\n\t})\n}\n\n/**\n * Loads a snapshot of the editor's instance state into the store of a new editor instance.\n *\n * @public\n * @param store - The store to load the instance state into\n * @param snapshot - The instance state snapshot to load\n * @returns\n */\nexport function loadSessionStateSnapshotIntoStore(\n\tstore: TLStore,\n\tsnapshot: TLSessionStateSnapshot\n) {\n\tconst res = migrateAndValidateSessionStateSnapshot(snapshot)\n\tif (!res) return\n\n\t// remove all page states and cameras and the instance state\n\tconst allPageStatesAndCameras = store\n\t\t.allRecords()\n\t\t.filter((r) => r.typeName === 'instance_page_state' || r.typeName === 'camera')\n\n\tconst removeDiff: RecordsDiff<TLRecord> = {\n\t\tadded: {},\n\t\tupdated: {},\n\t\tremoved: {\n\t\t\t...objectMapFromEntries(allPageStatesAndCameras.map((r) => [r.id, r])),\n\t\t},\n\t}\n\tif (store.has(TLINSTANCE_ID)) {\n\t\tremoveDiff.removed[TLINSTANCE_ID] = store.get(TLINSTANCE_ID)!\n\t}\n\n\tconst addDiff: RecordsDiff<TLRecord> = {\n\t\tremoved: {},\n\t\tupdated: {},\n\t\tadded: {\n\t\t\t[TLINSTANCE_ID]: store.schema.types.instance.create({\n\t\t\t\tid: TLINSTANCE_ID,\n\t\t\t\tcurrentPageId: res.currentPageId,\n\t\t\t\tisDebugMode: res.isDebugMode,\n\t\t\t\tisFocusMode: res.isFocusMode,\n\t\t\t\tisToolLocked: res.isToolLocked,\n\t\t\t\tisGridMode: res.isGridMode,\n\t\t\t\texportBackground: res.exportBackground,\n\t\t\t}),\n\t\t},\n\t}\n\n\t// replace them with new ones\n\tfor (const ps of res.pageStates) {\n\t\tconst cameraId = CameraRecordType.createId(ps.pageId)\n\t\tconst pageStateId = InstancePageStateRecordType.createId(ps.pageId)\n\t\taddDiff.added[cameraId] = CameraRecordType.create({\n\t\t\tid: CameraRecordType.createId(ps.pageId),\n\t\t\tx: ps.camera.x,\n\t\t\ty: ps.camera.y,\n\t\t\tz: ps.camera.z,\n\t\t})\n\t\taddDiff.added[pageStateId] = InstancePageStateRecordType.create({\n\t\t\tid: InstancePageStateRecordType.createId(ps.pageId),\n\t\t\tpageId: ps.pageId,\n\t\t\tselectedShapeIds: ps.selectedShapeIds,\n\t\t\tfocusedGroupId: ps.focusedGroupId,\n\t\t})\n\t}\n\n\ttransact(() => {\n\t\tstore.applyDiff(squashRecordDiffs([removeDiff, addDiff]))\n\t\tstore.ensureStoreIsUsable()\n\t})\n}\n\n/**\n * @internal\n */\nexport function extractSessionStateFromLegacySnapshot(\n\tstore: Record<string, UnknownRecord>\n): TLSessionStateSnapshot | null {\n\tconst instanceRecords = []\n\tfor (const record of Object.values(store)) {\n\t\tif (record.typeName?.match(/^(instance.*|pointer|camera)$/)) {\n\t\t\tinstanceRecords.push(record)\n\t\t}\n\t}\n\n\t// for scratch documents, we need to extract the most recently-used instance and it's associated page states\n\t// but oops we don't have the concept of \"most recently-used\" so we'll just take the first one\n\tconst oldInstance = instanceRecords.filter(\n\t\t(r) => r.typeName === 'instance' && r.id !== TLINSTANCE_ID\n\t)[0] as any\n\tif (!oldInstance) return null\n\n\tconst result: TLSessionStateSnapshot = {\n\t\tversion: CURRENT_SESSION_STATE_SNAPSHOT_VERSION,\n\t\tcurrentPageId: oldInstance.currentPageId,\n\t\texportBackground: !!oldInstance.exportBackground,\n\t\tisFocusMode: !!oldInstance.isFocusMode,\n\t\tisDebugMode: !!oldInstance.isDebugMode,\n\t\tisToolLocked: !!oldInstance.isToolLocked,\n\t\tisGridMode: false,\n\t\tpageStates: instanceRecords\n\t\t\t.filter((r: any) => r.typeName === 'instance_page_state' && r.instanceId === oldInstance.id)\n\t\t\t.map((ps: any): TLSessionStateSnapshot['pageStates'][0] => {\n\t\t\t\tconst camera = (store[ps.cameraId] as any) ?? { x: 0, y: 0, z: 1 }\n\t\t\t\treturn {\n\t\t\t\t\tpageId: ps.pageId,\n\t\t\t\t\tcamera: {\n\t\t\t\t\t\tx: camera.x,\n\t\t\t\t\t\ty: camera.y,\n\t\t\t\t\t\tz: camera.z,\n\t\t\t\t\t},\n\t\t\t\t\tselectedShapeIds: ps.selectedShapeIds,\n\t\t\t\t\tfocusedGroupId: ps.focusedGroupId,\n\t\t\t\t}\n\t\t\t}),\n\t}\n\n\ttry {\n\t\tsessionStateSnapshotValidator.validate(result)\n\t\treturn result\n\t} catch (e) {\n\t\treturn null\n\t}\n}\n"],
  "mappings": "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",
  "names": []
}
